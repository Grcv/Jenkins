pipeline {
    agent any

    parameters {
        string(name: 'REMOTE_HOST', defaultValue: '192.168.1.100', description: 'IP del servidor remoto para desplegar')
    }

    environment {
        BUILD_TAG = "aceros"
        SSH_CREDENTIALS_ID = 'remote_ssh'
    }

    stages {

        stage('Copiar docker-compose.yml al servidor remoto') {
            steps {
                sshagent (credentials: [SSH_CREDENTIALS_ID]) {
                    // Ajusta la ruta a tu archivo docker-compose.yml local si está en otra carpeta
                    sh """
                    scp -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${params.REMOTE_HOST}:/home/ubuntu
                    """
                }
            }
        }

        stage('Desplegar con docker-compose en servidor remoto') {
            steps {
                sshagent (credentials: [SSH_CREDENTIALS_ID]) {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh """
                        ssh -o StrictHostKeyChecking=no ubuntu@${params.REMOTE_HOST} "\
                            mkdir -p ~/aceros_app && \
                            cd ~/aceros_app && \
                            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} && \
                            docker pull ${DOCKER_USER}/${BUILD_TAG}_frontend && \
                            docker pull ${DOCKER_USER}/${BUILD_TAG}_backend && \
                            docker-compose down || true && \
                            IMAGE_FRONTEND=${DOCKER_USER}/${BUILD_TAG}_frontend IMAGE_BACKEND=${DOCKER_USER}/${BUILD_TAG}_backend docker-compose up -d"
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Despliegue remoto con docker-compose completado en ${params.REMOTE_HOST}."
        }
        failure {
            echo "❌ Falló el despliegue remoto."
        }
    }
}
