pipeline {
    agent any

    parameters {
        string(name: 'REMOTE_HOST', defaultValue: 'ec2-54-158-26-151.compute-1.amazonaws.com', description: 'IP del servidor remoto para desplegar')
        string(name: 'PORT', defaultValue: '8080', description: 'Puerto del servidor remoto para desplegar')
    }

    environment {
        BUILD_TAG = "ikigai-vocacional"
        SSH_CREDENTIALS_ID = 'remote_ssh'
    }

    stages {

        stage('Desplegar con docker-compose en servidor remoto') {
            steps {
                sshagent (credentials: [SSH_CREDENTIALS_ID]) {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                       
                            sh """
                                
                                docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} &&
                                docker rm -f ikigai-app || true &&
                                docker pull ${DOCKER_USER}/${BUILD_TAG} &&
                                docker run -d -p  ${params.PORT}:8080 --name ikigai-app ${DOCKER_USER}/${BUILD_TAG}
                                '
                            """
                        
                    }
                }
            }
        }


    }

    post {
        success {
            echo "✅ Despliegue completo y certificado SSL instalado en ${params.REMOTE_HOST}."
        }
        failure {
            echo "❌ Falló el despliegue remoto o la instalación del certificado SSL."
        }
    }
}
